{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Empleado{% endblock %}

{% block page_title %}Formulario de Empleado{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <a href="{{ next|default_if_none:request.META.HTTP_REFERER|default:form.instance.get_absolute_url }}" class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-500 mb-6">
        <i data-lucide="arrow-left"></i> Volver
    </a>
<form id="employee-form" method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
        <h2 class="text-2xl font-bold text-center mb-8">Editar Empleado</h2>
        {% if form.errors or form.non_field_errors %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-md" role="alert">
                <p class="font-bold mb-2">Por favor, corrige los siguientes errores:</p>
                <ul class="list-disc list-inside text-sm">
                {% for field in form %}
                    {% if field.errors %}
                        <li><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</li>
                    {% endif %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            </div>
        {% endif %}
        <!-- Stepper -->
        <ol class="flex items-center w-full mb-8">
            <li id="step-indicator-1" class="flex w-full items-center text-sm font-medium text-gray-500 dark:text-gray-400 after:content-[''] after:w-full after:h-1 after:border-b after:border-gray-200 after:border-1 after:inline-block dark:after:border-gray-700"><span class="flex items-center justify-center w-8 h-8 rounded-full shrink-0">1</span></li>
            <li id="step-indicator-2" class="flex w-full items-center text-sm font-medium text-gray-500 dark:text-gray-400 after:content-[''] after:w-full after:h-1 after:border-b after:border-gray-200 after:border-1 after:inline-block dark:after:border-gray-700"><span class="flex items-center justify-center w-8 h-8 rounded-full shrink-0">2</span></li>
            <li id="step-indicator-3" class="flex w-full items-center text-sm font-medium text-gray-500 dark:text-gray-400 after:content-[''] after:w-full after:h-1 after:border-b after:border-gray-200 after:border-1 after:inline-block dark:after:border-gray-700"><span class="flex items-center justify-center w-8 h-8 rounded-full shrink-0">3</span></li>
            <li id="step-indicator-4" class="flex items-center text-sm font-medium text-gray-500 dark:text-gray-400"><span class="flex items-center justify-center w-8 h-8 rounded-full shrink-0">4</span></li>
        </ol>

        {% if form.non_field_errors %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}
        {% if error %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
                <p>{{ error }}</p>
            </div>
        {% endif %}

        <!-- Step 1: Datos Personales -->
        <div id="form-step-1" class="form-step">
            <h3 class="text-lg font-semibold mb-4">1. Datos Personales</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for field in form %}
                    {% if field.name == 'nombre' or field.name == 'apellido' or field.name == 'dni' or field.name == 'fecha_nacimiento' or field.name == 'genero' or field.name == 'estado_civil' or field.name == 'grupo' or field.name == 'estado' %}
                    <div>
                        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ field.errors|striptags }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Step 2: Datos de Contacto -->
        <div id="form-step-2" class="form-step hidden">
            <h3 class="text-lg font-semibold mb-4">2. Datos de Contacto</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for field in form %}
                    {% if field.name == 'telefono' or field.name == 'email' %}
                    <div>
                        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ field.errors|striptags }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Step 3: Foto del Empleado -->
        <div id="form-step-3" class="form-step hidden">
            <h3 class="text-lg font-semibold mb-4">3. Foto del Empleado</h3>
            <div>
                <label for="{{ form.ruta_foto.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ form.ruta_foto.label }}</label>
                {% if form.instance.ruta_foto %}
                    <div class="mb-2">
                        <img src="{{ form.instance.ruta_foto.url }}" alt="Foto actual" class="h-32 w-32 object-cover rounded-lg">
                        <p class="text-xs text-gray-500 mt-1">Foto actual</p>
                    </div>
                {% endif %}
                {{ form.ruta_foto }}
                {% if form.ruta_foto.errors %}
                    <div class="text-red-500 text-sm mt-1">{{ form.ruta_foto.errors|striptags }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Step 4: Documentación -->
        <div id="form-step-4" class="form-step hidden">
            <h3 class="text-lg font-semibold mb-4">4. Documentación Requerida</h3>
            <div class="space-y-3">
                {% for req in requisitos %}
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                    <div>
                        <p class="text-sm font-medium">{{ req.nombre_doc }} {% if req.obligatorio %}<span class="text-red-500">*</span>{% endif %}</p>
                        {% for doc in documentos %}
                            {% if doc.id_requisito.id == req.id and doc.ruta_archivo %}
                                <a href="{{ doc.ruta_archivo.url }}" target="_blank" class="text-xs text-blue-500 hover:underline">Ver archivo actual</a>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <input type="file" name="doc_{{ req.id }}" class="w-full md:w-auto text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100 dark:file:bg-red-900/50 dark:file:text-red-300 dark:hover:file:bg-red-900">
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="mt-8 pt-4 border-t dark:border-gray-700 flex justify-between items-center">
            <button type="button" id="form-prev-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 disabled:opacity-50" disabled>Anterior</button>
            <div>
                <a href="{{ next|default_if_none:'empleados' }}" class="px-4 py-2 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 mr-2">Cancelar</a>
                <button type="button" id="form-next-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">Siguiente</button>
                <button type="button" id="form-submit-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden">Guardar Cambios</button>
            </div>
        </div>
    </div>
</form>

<!-- Modal de Confirmación -->
<div id="confirm-submit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 m-4 text-center">
        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-yellow-100 dark:bg-yellow-900/50">
            <i data-lucide="alert-triangle" class="h-6 w-6 text-yellow-600 dark:text-yellow-400"></i>
        </div>
        <h2 id="confirm-title" class="text-xl font-semibold mt-4">Confirmar Cambios</h2>
        <p id="confirm-message" class="text-sm text-gray-500 dark:text-gray-400 mt-2">¿Estás seguro de guardar los cambios?</p>
        <div class="mt-6 flex justify-center gap-3">
            <button type="button" id="cancel-action-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 w-full">
                Cancelar
            </button>
            <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 w-full">
                Guardar
            </button>
        </div>
    </div>
</div>

</div>
{% endblock content %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmModal = document.getElementById('confirm-submit-modal');
    const confirmBtn = document.getElementById('confirm-action-btn');
    const cancelBtn = document.getElementById('cancel-action-btn');

    let currentFormStep = 1;
    const nextBtn = document.getElementById('form-next-btn');
    const prevBtn = document.getElementById('form-prev-btn');
    const submitBtn = document.getElementById('form-submit-btn');
    const form = document.getElementById('employee-form');
    
    // Deshabilitar botones de navegación/envío inicialmente
    nextBtn.disabled = true;
    submitBtn.disabled = true;

    function addValidationListeners() {
        const currentStepDiv = document.getElementById(`form-step-${currentFormStep}`);
        const inputs = currentStepDiv.querySelectorAll('input, select');
        inputs.forEach(input => input.addEventListener('input', validateStep));
        inputs.forEach(input => input.addEventListener('change', validateStep)); // Para selects y file inputs
    }

    // Manejo especial para el campo de fecha
    const fechaNacimientoInput = document.getElementById('id_fecha_nacimiento');
    if (fechaNacimientoInput) {
        // Convertir a campo de texto
        fechaNacimientoInput.type = 'text';
        fechaNacimientoInput.placeholder = 'dd/mm/aaaa';
        
        // Conservar el valor original en formato dd/mm/yyyy si existe
        const valorOriginal = fechaNacimientoInput.value;
        if (valorOriginal) {
            // Asegurarse de que el valor esté en formato dd/mm/yyyy
            if (valorOriginal.includes('-')) {
                const [año, mes, dia] = valorOriginal.split('-');
                fechaNacimientoInput.value = `${dia}/${mes}/${año}`;
            } else if (valorOriginal.includes('/')) {
                fechaNacimientoInput.value = valorOriginal;
            }
        }

        // Manejar la entrada de fecha
        fechaNacimientoInput.addEventListener('input', function(e) {
            let valor = e.target.value.replace(/\D/g, '');
            
            // Formatear automáticamente mientras se escribe
            if (valor.length > 0) {
                if (valor.length <= 2) {
                    e.target.value = valor;
                } else if (valor.length <= 4) {
                    e.target.value = `${valor.slice(0,2)}/${valor.slice(2)}`;
                } else {
                    e.target.value = `${valor.slice(0,2)}/${valor.slice(2,4)}/${valor.slice(4,8)}`;
                }
            }
            validateStep(); // Validar al cambiar la fecha
        });
    }

    function validateStep() {
        const currentStepDiv = document.getElementById(`form-step-${currentFormStep}`);
        // Django añade el atributo 'required' a los campos obligatorios del formulario.
        const inputs = currentStepDiv.querySelectorAll('input[required], select[required]');
        let allValid = true;

        inputs.forEach(input => {
            if (!input.value.trim()) {
                allValid = false;
            }
        });

        // En la edición, los pasos 3 (foto) y 4 (documentos) no tienen campos obligatorios
        // ya que los archivos son opcionales para actualizar.
        if (currentFormStep === 3 || currentFormStep === 4) {
            allValid = true;
        }

        nextBtn.disabled = !allValid;
        // El botón de guardar cambios se activa si el paso 4 es válido (siempre lo es en este caso).
        submitBtn.disabled = !(currentFormStep === 4 && allValid);
    }

    function updateFormStepUI() {
        document.querySelectorAll('.form-step').forEach(step => step.classList.add('hidden'));
        document.getElementById(`form-step-${currentFormStep}`).classList.remove('hidden');

        for (let i = 1; i <= 4; i++) {
            const indicator = document.getElementById(`step-indicator-${i}`);
            indicator.classList.remove('step-active', 'step-completed');
            if (i < currentFormStep) {
                indicator.classList.add('step-completed');
            } else if (i === currentFormStep) {
                indicator.classList.add('step-active');
            }
        }

        prevBtn.disabled = currentFormStep === 1;
        if (currentFormStep === 4) {
            nextBtn.classList.add('hidden');
            submitBtn.classList.remove('hidden');
        } else {
            nextBtn.classList.remove('hidden');
            submitBtn.classList.add('hidden');
        }
        addValidationListeners();
        validateStep(); // Validar el estado inicial del paso
    }

    nextBtn.addEventListener('click', () => {
        if (currentFormStep < 4) {
            currentFormStep++;
            updateFormStepUI();
        }
    });
    prevBtn.addEventListener('click', () => {
        if (currentFormStep > 1) {
            currentFormStep--;
            updateFormStepUI();
        }
    });
    
    const formFields = document.querySelectorAll('input[type="text"], input[type="email"], input[type="number"], input[type="date"], input[type="tel"], select');
    formFields.forEach(field => {
        field.classList.add('mt-1', 'block', 'w-full', 'rounded-md', 'border-gray-300', 'dark:border-gray-600', 'dark:bg-gray-700', 'shadow-sm');
    });

    const fileFields = document.querySelectorAll('input[type="file"]');
    fileFields.forEach(field => {
        if (field.name.startsWith('doc_')) return; // Don't style the document uploads yet
        field.classList.add('mt-1', 'block', 'w-full', 'text-sm', 'text-gray-500', 'file:mr-4', 'file:py-2', 'file:px-4', 'file:rounded-full', 'file:border-0', 'file:text-sm', 'file:font-semibold', 'file:bg-gray-50', 'file:text-gray-700', 'hover:file:bg-gray-100', 'dark:file:bg-gray-700', 'dark:file:text-gray-300', 'dark:hover:file:bg-gray-600');
    });

    const nombreInput = document.getElementById('id_nombre');
    const apellidoInput = document.getElementById('id_apellido');
    const dniInput = document.getElementById('id_dni');
    const telefonoInput = document.getElementById('id_telefono');

    const soloLetras = (e) => {
        e.target.value = e.target.value.replace(/[^a-zA-Z\s]/g, '');
    };

    const soloNumeros = (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    };

    if (nombreInput) nombreInput.addEventListener('input', soloLetras);
    if (apellidoInput) apellidoInput.addEventListener('input', soloLetras);
    if (telefonoInput) telefonoInput.addEventListener('input', soloNumeros);
    if (dniInput) {
        dniInput.addEventListener('input', (e) => {
            soloNumeros(e);
            if (e.target.value.length > 8) e.target.value = e.target.value.slice(0, 8);
        });
    }

    // --- Lógica del Modal de Confirmación ---
    submitBtn.addEventListener('click', function() {
        // Al hacer clic en el botón "Guardar Cambios", mostramos el modal.
        // Como el botón ya no es de tipo "submit", no necesitamos preventDefault().
        confirmModal.classList.remove('hidden');
        confirmModal.classList.add('flex');
    });


    cancelBtn.addEventListener('click', function() {
        confirmModal.classList.add('hidden');
        confirmModal.classList.remove('flex');
    });

    confirmBtn.addEventListener('click', function() {
        // Si el usuario confirma, se dispara el evento submit del formulario
        form.submit();
    });

    form.addEventListener('submit', function(e) {
        // Antes de enviar, convertir el formato de la fecha para el backend
        if (fechaNacimientoInput) {
            const fechaVisible = fechaNacimientoInput.value;
            if (fechaVisible && fechaVisible.includes('/')) {
                const partes = fechaVisible.split('/');
                if (partes.length === 3) {
                    // Reordenar de dd/mm/yyyy a yyyy-mm-dd
                    const dia = partes[0];
                    const mes = partes[1];
                    const anio = partes[2];
                    // Solo convierte si es una fecha válida en formato dd/mm/yyyy
                    if (dia.length === 2 && mes.length === 2 && anio.length === 4) {
                        fechaNacimientoInput.value = `${anio}-${mes}-${dia}`;
                    }
                }
            }
        }
    });

    updateFormStepUI();
});

</script>
{% endblock page_scripts %}