{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Empleados{% endblock %}

{% block page_title %}Gestión de Empleados{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
    <div class="flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto flex-grow">
        <div class="relative w-full sm:max-w-xs group">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 transition-colors group-hover:text-red-500"></i>
            <input type="text" id="search-input" 
                placeholder="Buscar por nombre o DNI..." 
                class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-gray-200 dark:border-gray-600 
                       bg-white dark:bg-gray-700 focus:ring-2 focus:ring-red-500/20 focus:border-red-500
                       transition-all duration-200"
                oninput="this.value = this.value.replace(/[^a-zA-Z0-9\sáéíóúÁÉÍÓÚüÜñÑ]/g, '');">
        </div>
        
        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
            <select id="estado-filter" 
                class="py-2.5 px-4 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700
                       focus:ring-2 focus:ring-red-500/20 focus:border-red-500 cursor-pointer transition-all duration-200
                       hover:border-red-500/50">
                <option value="">Todos los Estados</option>
                {% for value, display in estado_choices %}
                <option value="{{ value }}">{{ display }}</option>
                {% endfor %}
            </select>

            <select id="cargo-filter" 
                class="py-2.5 px-4 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700
                       focus:ring-2 focus:ring-red-500/20 focus:border-red-500 cursor-pointer transition-all duration-200
                       hover:border-red-500/50">
                <option value="">Todos los Cargos</option>
                {% for cargo in cargos %}
                <option value="{{ cargo.id }}">{{ cargo.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="w-full sm:w-auto flex flex-col sm:flex-row items-center gap-3">
        <a href="{% url 'generar_lista_empleados_pdf' %}" target="_blank" 
           class="w-full sm:w-auto flex-shrink-0 bg-gray-600 text-white px-5 py-2.5 rounded-lg 
                  flex items-center justify-center gap-2 hover:bg-gray-700 text-sm font-medium
                  transition-all duration-200 hover:shadow-lg hover:scale-105">
            <i data-lucide="printer" class="w-4 h-4"></i> Imprimir Lista
        </a>
        <a href="{% url 'crear_empleado' %}" 
           class="w-full sm:w-auto flex-shrink-0 bg-red-600 text-white px-5 py-2.5 rounded-lg 
                  flex items-center justify-center gap-2 hover:bg-red-700 font-medium
                  transition-all duration-200 hover:shadow-lg hover:scale-105">
            <i data-lucide="plus"></i><span>Registrar Empleado</span>
        </a>
    </div>
</div>

<div id="employee-list">
    {% include 'lista_empleados.html' %}
</div>
<!-- Contenedor donde colocaremos la paginación al final de la página -->
<div id="page-bottom-pagination" class="mt-6 px-4 sm:px-6"></div>

<!-- Modal de Confirmación de Eliminación -->
<div id="delete-employee-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 m-4 text-center" onclick="event.stopPropagation()">
        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/50">
            <i data-lucide="trash-2" class="h-6 w-6 text-red-600 dark:text-red-400"></i>
        </div>
        <h2 class="text-xl font-semibold mt-4">Eliminar Empleado</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
            ¿Estás seguro de que deseas eliminar a <strong id="employee-name-modal"></strong>? Esta acción no se puede deshacer.
        </p>
        <div class="mt-6 flex justify-center gap-3">
            <button type="button" id="cancel-delete-button"
                class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 w-full">
                Cancelar
            </button>
            <a href="#" id="confirm-delete-button"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 w-full inline-flex items-center justify-center">
                Confirmar
            </a>
        </div>
    </div>
</div>
{% endblock content %}

{% block page_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const { computePosition, flip, shift, offset, autoUpdate } = FloatingUIDOM;
        let activeCleanup = null;

        // --- Búsqueda y Filtro de Empleados (AJAX) ---
        const searchInput = document.getElementById('search-input');
        const estadoFilter = document.getElementById('estado-filter');
        const cargoFilter = document.getElementById('cargo-filter');
        const employeeListContainer = document.getElementById('employee-list');
        const bottomPagination = document.getElementById('page-bottom-pagination');

        function movePagination() {
            const pagination = employeeListContainer.querySelector('#employee-pagination');
            if (pagination && bottomPagination) {
                bottomPagination.innerHTML = '';
                bottomPagination.appendChild(pagination);
            } else if (bottomPagination) {
                bottomPagination.innerHTML = ''; // Limpiar si no hay paginación
            }
        }

        function performSearch() {
            const query = searchInput.value;
            const estado = estadoFilter.value;
            const cargo = cargoFilter.value;
            
            // Construir la URL con parámetros de consulta
            const url = `{% url 'buscar_empleados' %}?q=${encodeURIComponent(query)}&estado=${encodeURIComponent(estado)}&cargo=${encodeURIComponent(cargo)}`;
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    employeeListContainer.innerHTML = html;
                    movePagination();
                    lucide.createIcons();
                });
        }

        // Mover paginación inicial al cargar la página
        movePagination();
        lucide.createIcons();

        // Listeners para los filtros y la búsqueda
        searchInput.addEventListener('keyup', performSearch);
        estadoFilter.addEventListener('change', performSearch);
        cargoFilter.addEventListener('change', performSearch);

        // --- Lógica de Menús y Notificaciones (Event Delegation) ---
        const deleteModal = document.getElementById('delete-employee-modal');
        const employeeNameModal = document.getElementById('employee-name-modal');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const cancelDeleteButton = document.getElementById('cancel-delete-button');

        function openDeleteModal(url, employeeName) {
            employeeNameModal.textContent = employeeName;
            confirmDeleteButton.href = url;
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('flex');
        }

        function closeDeleteModal() {
            deleteModal.classList.add('hidden');
            deleteModal.classList.remove('flex');
        }

        cancelDeleteButton.addEventListener('click', closeDeleteModal);
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                closeDeleteModal();
            }
        });

        document.body.addEventListener('click', function(e) {
            const toggleButton = e.target.closest('[data-action="toggle-menu"]');
            const deleteButton = e.target.closest('[data-action="delete-employee"]');

            if (toggleButton) {
                e.preventDefault();
                const menu = toggleButton.nextElementSibling;

                if (activeCleanup && activeCleanup.menu === menu) {
                    activeCleanup();
                    activeCleanup = null;
                    return;
                }

                if (activeCleanup) {
                    activeCleanup();
                    activeCleanup = null;
                }

                menu.classList.remove('hidden');
                const cleanup = autoUpdate(toggleButton, menu, () => {
                    computePosition(toggleButton, menu, {
                        placement: 'bottom-end',
                        middleware: [
                            offset(8),
                            flip(),
                            shift({ padding: 8 })
                        ]
                    }).then(({ x, y }) => {
                        Object.assign(menu.style, {
                            left: `${x}px`,
                            top: `${y}px`,
                        });
                    });
                });

                activeCleanup = () => {
                    cleanup();
                    menu.classList.add('hidden');
                };
                activeCleanup.menu = menu;

            } else if (deleteButton) {
                e.preventDefault();
                const url = deleteButton.href;
                const employeeName = deleteButton.dataset.employeeName;
                openDeleteModal(url, employeeName);

            } else if (!e.target.closest('[data-menu]')) {
                if (activeCleanup) {
                    activeCleanup();
                    activeCleanup = null;
                }
            }
        });
    });
</script>
{% endblock page_scripts %}
