{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Asistencia{% endblock %}

{% block page_title %}Asistencia{% endblock %}

{% block content %}
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
    <div class="border-b border-gray-200 dark:border-gray-700">
        <nav class="-mb-px flex space-x-6 px-6 overflow-x-auto" aria-label="Tabs">
            <a href="#register-face" data-tab="register-face" class="attendance-tab tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Registrar Rostro</a>
            <a href="#modify-face" data-tab="modify-face" class="attendance-tab tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Modificar Rostro</a>
            <a href="#register-attendance" data-tab="register-attendance" class="attendance-tab tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Registrar Asistencia</a>
            <a href="#view-attendances" data-tab="view-attendances" class="attendance-tab tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Ver Asistencias</a>
        </nav>
    </div>
    <div class="p-6">
        <div id="register-attendance-tab" class="attendance-tab-content">
            {% include 'marcar_asistencia_tab.html' %}
        </div>
        <div id="register-face-tab" class="attendance-tab-content hidden">
            {% include 'registrar_rostro_tab.html' %}
        </div>
        <div id="modify-face-tab" class="attendance-tab-content hidden">
            {% include 'modificar_rostro_tab.html' %}
        </div>
        <div id="view-attendances-tab" class="attendance-tab-content hidden">
            {% include 'ver_asistencias_tab.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function setupTabs(prefix) {
        document.querySelectorAll(`.${prefix}-tab`).forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const tabId = button.dataset.tab;
                window.location.hash = tabId;
                switchTab(prefix, tabId);
            });
        });
    }

    function switchTab(prefix, tabId) {
        document.querySelectorAll(`.${prefix}-tab-content`).forEach(content => {
            content.classList.add('hidden');
        });
        document.querySelectorAll(`.${prefix}-tab`).forEach(button => {
            button.classList.remove('tab-active');
            button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300');
        });

        const tabContent = document.getElementById(`${tabId}-tab`);
        if(tabContent) {
            tabContent.classList.remove('hidden');
        }

        const activeButton = document.querySelector(`.${prefix}-tab[data-tab="${tabId}"]`);
        if(activeButton) {
            activeButton.classList.add('tab-active');
            activeButton.classList.remove('border-transparent', 'text-gray-500');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        setupTabs('attendance');
        // Activate tab based on URL hash
        const hash = window.location.hash.substring(1);
        const validTabs = ['register-attendance', 'register-face', 'view-attendances'];
        if (hash && validTabs.includes(hash)) {
            switchTab('attendance', hash);
        } else {
            switchTab('attendance', 'register-attendance');
        }
    });

    // Script for marcar_asistencia_tab.html
    const videoMark = document.getElementById('video-mark');
    const canvasMark = document.getElementById('canvas-mark');
    const statusDivMark = document.getElementById('status-mark');
    let processingMark = false;

    if (videoMark) {
        videoMark.style.transform = "scaleX(-1)"; // <-- Añade esta línea para el efecto selfie
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoMark.srcObject = stream;
            })
            .catch(err => {
                console.error("Error al acceder a la cÃ¡mara: ", err);
                statusDivMark.innerHTML = `<span class="badge bg-danger">Error de cÃ¡mara</span>`;
            });

        const recognizeFace = () => {
            if (processingMark) return;
            processingMark = true;

            const context = canvasMark.getContext('2d');
            canvasMark.width = videoMark.videoWidth;
            canvasMark.height = videoMark.videoHeight;
            context.drawImage(videoMark, 0, 0, canvasMark.width, canvasMark.height);
            const imageData = canvasMark.toDataURL('image/jpeg');

            const formData = new FormData();
            formData.append('image', imageData);

            fetch("{% url 'api_reconocer_rostro' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusDivMark.innerHTML = `<span class="badge bg-success">Asistencia registrada para ${data.nombre}!</span>`;
                } else if (data.status === 'already_marked') {
                    statusDivMark.innerHTML = `<span class="badge bg-warning"> ${data.nombre}, ya has marcado asistencia hoy.</span>`;
                } else if (data.status === 'outside_shift') {
                    statusDivMark.innerHTML = `<span class="badge bg-danger">${data.nombre}, ${data.message}</span>`;
                }
                processingMark = false;
            })
            .catch(() => {
                processingMark = false;
            });
        };

        setInterval(recognizeFace, 2000);
    }

    // Script for registrar_rostro_tab.html
    const videoRegister = document.getElementById('video-register');
    const canvasRegister = document.getElementById('canvas-register');
    const captureBtn = document.getElementById('captureBtn');
    const empleadoSelect = document.getElementById('empleadoSelect');
    const resultRegister = document.getElementById('result-register');

    if (videoRegister) {
        videoRegister.style.transform = "scaleX(-1)"; // <-- Añade esta línea para el efecto selfie
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoRegister.srcObject = stream;
            })
            .catch(err => {
                console.error("Error al acceder a la cÃ¡mara: ", err);
                // Handle error in UI
            });

        captureBtn.addEventListener('click', () => {
            const empleadoId = empleadoSelect.value;
            if (!empleadoId) {
                resultRegister.innerHTML = `<p class="text-red-500 font-semibold">Por favor, seleccione un empleado.</p>`;
                return;
            }

            const context = canvasRegister.getContext('2d');
            canvasRegister.width = videoRegister.videoWidth;
            canvasRegister.height = videoRegister.videoHeight;
            
            // Invertimos el canvas horizontalmente para que la captura coincida con la vista previa
            context.translate(canvasRegister.width, 0);
            context.scale(-1, 1);
            
            context.drawImage(videoRegister, 0, 0, canvasRegister.width, canvasRegister.height);
            
            const imageData = canvasRegister.toDataURL('image/jpeg');

            // 1. Mostrar la vista previa de la captura
            resultRegister.innerHTML = `
                <img src="${imageData}" alt="Captura de rostro" class="rounded-lg border-2 border-gray-300 dark:border-gray-600 shadow-md">
                <p class="mt-2 text-sm text-gray-500">Procesando...</p>`;

            const formData = new FormData();
            formData.append('empleado_id', empleadoId);
            formData.append('image', imageData);

            fetch("{% url 'api_guardar_rostro' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                // 2. Mostrar mensaje de éxito o error
                if (data.status === 'success') {
                    resultRegister.innerHTML += `<p class="mt-2 font-semibold text-green-600">${data.message}</p><p class="text-sm">La página se recargará en 3 segundos...</p>`;
                    // 3. Recargar la página después de 3 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    resultRegister.innerHTML += `<p class="mt-2 font-semibold text-red-500">Error: ${data.message}</p>`;
                }
            })
            .catch(err => {
                console.error('Error en la petición:', err);
                resultRegister.innerHTML += `<p class="mt-2 font-semibold text-red-500">Ocurrió un error de red. Inténtelo de nuevo.</p>`;
            });
        });
    }

    // Script for modificar_rostro_tab.html
    const videoModify = document.getElementById('video-modify');
    const canvasModify = document.getElementById('canvas-modify');
    const captureBtnModify = document.getElementById('captureBtn-modify');
    const empleadoSelectModify = document.getElementById('empleadoSelect-modify');
    const resultModify = document.getElementById('result-modify');

    if (videoModify) {
        videoModify.style.transform = "scaleX(-1)";
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoModify.srcObject = stream;
            })
            .catch(err => {
                console.error("Error al acceder a la cámara: ", err);
                resultModify.innerHTML = `<p class="text-red-500 font-semibold">Error al acceder a la cámara.</p>`;
            });

        captureBtnModify.addEventListener('click', () => {
            const empleadoId = empleadoSelectModify.value;
            if (!empleadoId) {
                resultModify.innerHTML = `<p class="text-red-500 font-semibold">Por favor, seleccione un empleado.</p>`;
                return;
            }

            const context = canvasModify.getContext('2d');
            canvasModify.width = videoModify.videoWidth;
            canvasModify.height = videoModify.videoHeight;
            
            context.translate(canvasModify.width, 0);
            context.scale(-1, 1);
            
            context.drawImage(videoModify, 0, 0, canvasModify.width, canvasModify.height);
            
            const imageData = canvasModify.toDataURL('image/jpeg');

            resultModify.innerHTML = `
                <img src="${imageData}" alt="Captura de rostro" class="rounded-lg border-2 border-gray-300 dark:border-gray-600 shadow-md">
                <p class="mt-2 text-sm text-gray-500">Procesando actualización...</p>`;

            const formData = new FormData();
            formData.append('empleado_id', empleadoId);
            formData.append('image', imageData);

            fetch("{% url 'api_guardar_rostro' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    resultModify.innerHTML += `<p class="mt-2 font-semibold text-green-600">${data.message}</p><p class="text-sm">La página se recargará en 3 segundos...</p>`;
                    setTimeout(() => { window.location.reload(); }, 3000);
                } else {
                    resultModify.innerHTML += `<p class="mt-2 font-semibold text-red-500">Error: ${data.message}</p>`;
                }
            })
            .catch(err => {
                console.error('Error en la petición:', err);
                resultModify.innerHTML += `<p class="mt-2 font-semibold text-red-500">Ocurrió un error de red. Inténtelo de nuevo.</p>`;
            });
        });
    }

    // Script for ver_asistencias_tab.html
    const searchBtn = document.getElementById('asistencia-search-btn');
    const dniInput = document.getElementById('asistencia-dni-input');
    const resultsContainer = document.getElementById('asistencia-results-container');
    const employeeNameSpan = document.getElementById('asistencia-employee-name');
    const listContainer = document.getElementById('asistencia-list');
    const noSearchMessage = document.getElementById('asistencia-no-search-message');
    const paginationContainer = document.getElementById('asistencia-pagination-container');
    const periodFilterForm = document.getElementById('asistencia-period-filter-form');
    const clearBtn = document.getElementById('asistencia-clear-btn');
    const porPaginaSelect = document.getElementById('por_pagina_tab');

    if (searchBtn) {
        const fetchAndRenderAsistencias = (dni, params = {}) => {
            if (!dni) {
                showNotification('warning', 'DNI Requerido', 'Por favor, ingrese un DNI para buscar.');
                return;
            }

            // Construir los parámetros de la URL
            const urlParams = new URLSearchParams();
            const formData = new FormData(periodFilterForm);

            // Añadir todos los parámetros del formulario y los pasados a la función
            for (const [key, value] of formData.entries()) { if (value) urlParams.set(key, value); }
            for (const [key, value] of Object.entries(params)) { if (value) urlParams.set(key, value); }

            let url = `/asistencia/api/ver-asistencias/${dni}/?${urlParams.toString()}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const locale = 'es-ES';

                    if (data.status === 'success') {
                        employeeNameSpan.textContent = `${data.empleado.nombre} ${data.empleado.apellido}`;
                        let tableHtml = '<table class="w-full text-left"><thead class="bg-gray-50 dark:bg-gray-700 text-sm font-semibold text-gray-600 dark:text-gray-300"><tr><th class="p-4">Fecha</th><th class="p-4">Día</th><th class="p-4">Hora de Ingreso</th><th class="p-4">Minutos de Retraso</th></tr></thead><tbody>';
                        
                        if (data.asistencias.length > 0) {
                            data.asistencias.forEach(asistencia => {
                            const fecha = new Date(asistencia.fecha_hora);
                            const diaSemana = fecha.toLocaleDateString(locale, { weekday: 'long' }).replace(/^\w/, c => c.toUpperCase());
                            
                            let retrasoBadge = '';
                            if (asistencia.minutos_retraso > 5) {
                                retrasoBadge = `<span class="inline-flex items-center px-2 py-1 text-xs font-medium text-red-700 bg-red-100 rounded-full dark:bg-red-900 dark:text-red-300">${asistencia.minutos_retraso} min - Tarde</span>`;
                            } else {
                                retrasoBadge = `<span class="inline-flex items-center px-2 py-1 text-xs font-medium text-green-700 bg-green-100 rounded-full dark:bg-green-900 dark:text-green-300">${asistencia.minutos_retraso} min - Correcto</span>`;
                            }

                            tableHtml += `<tr class="border-t dark:border-gray-700">
                                            <td class="p-4 text-gray-600 dark:text-gray-300">${fecha.toLocaleDateString(locale, {timeZone: 'UTC'})}</td>
                                            <td class="p-4 text-gray-600 dark:text-gray-300">${diaSemana}</td>
                                            <td class="p-4 font-semibold text-gray-800 dark:text-gray-100">${fecha.toLocaleTimeString(locale, {timeZone: 'UTC'})}</td>
                                            <td class="p-4 font-semibold">${retrasoBadge}</td>
                                         </tr>`;
                        });
                        } else {
                            tableHtml += `<tr><td colspan="3" class="p-6 text-center text-gray-500">No se encontraron asistencias para este periodo.</td></tr>`;
                        }
                        tableHtml += '</tbody></table>';
                        listContainer.innerHTML = tableHtml;

                        resultsContainer.classList.remove('hidden');
                        noSearchMessage.classList.add('hidden');
                        lucide.createIcons();

                        renderPagination(data.pagination);
                    } else {
                        showNotification('error', 'Error', data.message);
                        resultsContainer.classList.add('hidden');
                        noSearchMessage.classList.remove('hidden');
                    }
                });
        };

        const renderPagination = (pagination) => {
            if (pagination.num_pages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let paginationHtml = `
                <div class="flex items-center justify-between border-t border-gray-200 dark:border-gray-700 px-4 py-3 sm:px-6">
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                Mostrando <span class="font-medium">${pagination.start_index}</span> a <span class="font-medium">${pagination.end_index}</span> de <span class="font-medium">${pagination.total_results}</span> resultados
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">`;

            if (pagination.has_previous) {
                paginationHtml += `<a href="#" data-page="${pagination.previous_page_number}" class="pagination-link relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700"> <span class="sr-only">Anterior</span> <i data-lucide="chevron-left" class="h-5 w-5"></i> </a>`;
            }

            paginationHtml += `<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300"> Página ${pagination.number} de ${pagination.num_pages} </span>`;

            if (pagination.has_next) {
                paginationHtml += `<a href="#" data-page="${pagination.next_page_number}" class="pagination-link relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700"> <span class="sr-only">Siguiente</span> <i data-lucide="chevron-right" class="h-5 w-5"></i> </a>`;
            }

            paginationHtml += `</nav></div></div></div>`;
            paginationContainer.innerHTML = paginationHtml;
            lucide.createIcons();
        };

        searchBtn.addEventListener('click', () => {
            periodFilterForm.reset();
            fetchAndRenderAsistencias(dniInput.value);
        });

        dniInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                periodFilterForm.reset();
                fetchAndRenderAsistencias(dniInput.value);
            }
        });

        periodFilterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(periodFilterForm);
            const params = Object.fromEntries(formData.entries());
            fetchAndRenderAsistencias(dniInput.value, params);
        });

        clearBtn.addEventListener('click', () => {
            periodFilterForm.reset();
            fetchAndRenderAsistencias(dniInput.value);
        });

        porPaginaSelect.addEventListener('change', () => {
            const dni = dniInput.value;
            if (dni) fetchAndRenderAsistencias(dni);
        });

        // Event listener para los links de paginación
        resultsContainer.addEventListener('click', function(e) {
            const link = e.target.closest('.pagination-link');
            if (link) {
                e.preventDefault();
                const page = link.dataset.page;
                fetchAndRenderAsistencias(dniInput.value, { page: page });
            }
        });
    }
</script>
{% endblock %}
