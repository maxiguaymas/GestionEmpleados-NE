{% extends "base.html" %}

{% block title %}Ver Recibos{% endblock %}

{% block content %}
<main class="pt-4 min-vh-100 d-flex flex-column align-items-center" id="empleados">
    <h2 class="mb-4">Recibos de Sueldos</h2>

    <!-- Formulario de búsqueda -->
    <form method="get" class="row g-3 mb-4">
        <div class="col-auto">
            <select id="dni-select" name="id" class="form-control" style="width: 250px;"></select>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Buscar</button>
        </div>
    </form>


    <!-- Tabla de recibos -->
    
    <div class="col-lg-10 fondo-semi">
        <div class="table-responsive shadow rounded">
            <table class="table table-striped table-bordered align-middle datatable-spanish">
                <thead class="table-dark">
                    <tr>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>DNI</th>
                        <th>Fecha</th>
                        <th>Periodo</th>
                        <th>PDF</th>
                        <th>Imagen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for recibo in recibos %}
                    <tr>
                        <td>{{ recibo.id_empl.nombre }}</td>
                        <td>{{ recibo.id_empl.apellido }}</td>
                        <td>{{ recibo.id_empl.dni }}</td>
                        <td>{{ recibo.fecha_emision }}</td>
                        <td>{{ recibo.periodo }}</td>
                        <td>
                            {% if recibo.ruta_pdf %}
                            <a href="{{ recibo.ruta_pdf.url }}" class="btn btn-primary btn-sm" target="_blank">Ver
                                PDF</a>
                            {% else %}
                            <span class="text-muted">Sin archivo</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if recibo.ruta_imagen %}
                            <a href="{{ recibo.ruta_imagen.url }}" class="btn btn-primary btn-sm" target="_blank">Ver
                                Imagen</a>
                            {% else %}
                            <span class="text-muted">Sin imagen</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">No hay recibos de sueldos registrados.</td>
                        {# Las siguientes 5 celdas vacías son necesarias para que DataTables no dé error #}
                        <td style="display: none;"></td>
                        <td style="display: none;"></td>
                        <td style="display: none;"></td>
                        <td style="display: none;"></td>
                        <td style="display: none;"></td>
                        <td style="display: none;"></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
</main>
{% endblock %}

{% block page_scripts %}
<!-- Select2 CSS y JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/es.js"></script>

<script>
    $(document).ready(function () {
        // Inicialización de Select2 para buscar empleados
        $('#dni-select').select2({
            placeholder: "Buscar empleado por DNI...",
            allowClear: true,
            language: "es",
            ajax: {
                url: "{% url 'ajax_buscar_empleado' %}",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return { q: params.term };
                },
                processResults: function (data) {
                    return { results: data.results };
                },
                cache: true
            },
            minimumInputLength: 2,
        });

        // Inicialización de DataTables con filtro personalizado
        // Usamos la clase .datatable-spanish que definimos en la tabla
        var table = $('.datatable-spanish').DataTable({
            searching: false, // Mantenemos deshabilitado el campo de búsqueda general
            lengthChange: true, // Habilita el selector de "Mostrar X entradas"
            dom: 'lrt<"d-flex justify-content-between mt-2"ip>', // Estructura: l=length, r=processing, t=table, i=info, p=pagination
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json'
            }
        });
    });
</script>
{% endblock %}