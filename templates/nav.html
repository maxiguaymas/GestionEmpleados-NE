{% load static %}
{% load auth_extras %}

<header class="relative h-16 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 sm:px-6 flex-shrink-0 transition-colors duration-200">
    <div class="flex items-center gap-4">
        <button id="open-mobile-menu" class="lg:hidden text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-lg transition-colors duration-150">
            <i data-lucide="menu" class="w-5 h-5"></i>
        </button>
        <h1 id="view-title" class="text-lg sm:text-xl font-semibold bg-gradient-to-r from-red-600 to-red-500 bg-clip-text text-transparent">
            {{ page_title|default:"Dashboard" }}
        </h1>
    </div>

    <div class="flex items-center gap-3 sm:gap-4">
        <button id="theme-toggle" 
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition-all duration-150 hover:scale-105">
            <span id="theme-toggle-dark-icon" class="hidden"><i data-lucide="moon"></i></span>
            <span id="theme-toggle-light-icon" class="hidden"><i data-lucide="sun"></i></span>
        </button>

        <div class="relative">
            <button id="notification-toggle" 
                class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 transition-all duration-150 hover:scale-105">
                <i data-lucide="bell" class="w-5 h-5"></i>
                {% if notificaciones_count > 0 %}
                <span class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-4 w-4 bg-red-500 text-[10px] text-white font-medium items-center justify-center">
                        {{ notificaciones_count }}
                    </span>
                </span>
                {% endif %}
            </button>
            <div id="notification-panel"
                class="hidden absolute mt-2 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border dark:border-gray-700 z-20 w-full max-w-sm right-4 left-4 sm:left-auto sm:right-0 sm:w-96 sm:max-w-none">
                <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
                    <h3 class="font-semibold">Notificaciones ({{ notificaciones_count }})</h3>
                    <form action="{% url 'notificaciones:marcar_todas_leidas' %}" method="POST" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="text-sm text-red-600 hover:underline bg-transparent border-none cursor-pointer p-0">Marcar como leídas</button>
                    </form>
                </div>
                <div id="notification-list" class="max-h-96 overflow-y-auto divide-y dark:divide-gray-700">
                    {% if notificaciones_no_leidas %}
                        {% for notificacion in notificaciones_no_leidas %}
                        <a href="{{ notificacion.enlace|default:'#' }}" class="block p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                            <p class="text-sm font-medium text-gray-800 dark:text-gray-200">{{ notificacion.mensaje }}</p>
                            <span class="text-xs text-gray-500 dark:text-gray-400">{{ notificacion.fecha_creacion|timesince }} atrás</span>
                        </a>
                        {% endfor %}
                    {% else %}
                        <p class="p-4 text-center text-sm text-gray-500">No tienes notificaciones nuevas.</p>
                    {% endif %}
                </div>
                <div class="p-2 bg-gray-50 dark:bg-gray-700/50 border-t dark:border-gray-700 text-center">
                    <a href="{% url 'notificaciones:centro_notificaciones' %}" class="text-sm text-gray-600 dark:text-gray-300 hover:underline">Ver todas las notificaciones</a>
                </div>
            </div>
        </div>

        {% if user|is_admin %}
            {% if view_as_employee %}
            <a href="{% url 'switch_to_admin_view' %}" id="role-switcher"
                class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 flex items-center gap-2 text-sm whitespace-nowrap"
                title="Modo Admin">
                <i data-lucide="user-cog"></i>
                <span class="hidden sm:inline">Modo Admin</span>
            </a>
            {% else %}
            <a href="{% url 'switch_to_employee_view' %}" id="role-switcher"
                class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 flex items-center gap-2 text-sm whitespace-nowrap"
                title="Modo Empleado">
                <i data-lucide="user"></i>
                <span class="hidden sm:inline">Modo Empleado</span>
            </a>
            {% endif %}
        {% endif %}

        <div class="relative group">
            {% if user.empleado %}
                {% with iniciales=user.empleado.get_iniciales %}
                <div class="h-10 w-10 rounded-lg overflow-hidden transform transition-transform duration-200 hover:scale-105 hover:shadow-lg">
                    <img id="user-avatar" class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-110"
                        src="https://placehold.co/100x100/D9232D/FFFFFF?text={{iniciales}}" alt="Avatar">
                </div>
                {% endwith %}
            {% else %}
                <img id="user-avatar" class="h-10 w-10 rounded-full object-cover"
                    src="https://placehold.co/100x100/D9232D/FFFFFF?text={{ user|get_user_initials }}" alt="Avatar">
            {% endif %}
            <span class="absolute -right-1 -bottom-1 block h-3.5 w-3.5 rounded-full bg-green-400 ring-2 ring-white dark:ring-gray-800 transition-all duration-200"></span>
        </div>
    </div>
</header>