{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Horarios{% endblock %}

{% block page_title %}
<a href="javascript:history.back()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 mr-2">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left w-5 h-5 inline-block align-middle">
        <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
    </svg>
</a>Horarios{% endblock %}

{% block content %}
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm">
    <div class="border-b border-gray-200 dark:border-gray-700">
        <div class="overflow-x-auto">
            <nav class="-mb-px flex space-x-6 px-4 sm:px-6" aria-label="Tabs">
                <a href="#view-assignments" data-tab="view-assignments" class="schedule-tab tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm inline-flex items-center gap-2">
                    <i data-lucide="calendar-range" class="w-4 h-4"></i>
                    <span>Ver Asignaciones</span>
                </a>
                <a href="#assign-schedules" data-tab="assign-schedules" class="schedule-tab tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm inline-flex items-center gap-2">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span>Asignar Horarios</span>
                </a>
                <a href="#create-schedule" data-tab="create-schedule" class="schedule-tab tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm inline-flex items-center gap-2">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    <span>Crear Horario</span>
                </a>
                <a href="#history" data-tab="history" class="schedule-tab tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm inline-flex items-center gap-2">
                    <i data-lucide="history" class="w-4 h-4"></i>
                    <span>Historial</span>
                </a>
            </nav>
        </div>
    </div>
    <div class="p-6">
        <div id="view-assignments-tab" class="schedule-tab-content">
            {% include 'ver_horarios_asig_tab.html' %}
        </div>
        <div id="assign-schedules-tab" class="schedule-tab-content hidden">
            {% include 'asignar_horario_tab.html' %}
        </div>
        <div id="create-schedule-tab" class="schedule-tab-content hidden">
            {% include 'cargar_horario_tab.html' %}
        </div>
        <div id="history-tab" class="schedule-tab-content hidden">
            {% include 'historial_horarios_tab.html' %}
        </div>
    </div>
</div>

<div id="delete-horario-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4" onclick="closeDeleteModal()">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm" onclick="event.stopPropagation()">
        <div class="p-8 text-center">
            <div class="w-20 h-20 mx-auto flex items-center justify-center rounded-full bg-red-100 dark:bg-red-900/30 mb-6">
                <i data-lucide="trash-2" class="w-10 h-10 text-red-600 dark:text-red-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">¿Eliminar Horario?</h2>
            <p class="text-gray-500 dark:text-gray-400 mt-2">¿Estás seguro de que quieres eliminar este horario? Esta acción no se puede deshacer.</p>
        </div>
        <div class="grid grid-cols-2 gap-4 px-8 pb-8">
            <button type="button" onclick="closeDeleteModal()"
                class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 font-semibold text-lg">
                Cancelar
            </button>
            <a id="confirm-delete-btn" href="#"
                class="block text-center px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 font-semibold text-lg">
                Sí, Eliminar
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    // Script para mostrar notificaciones de Django
    {% if messages %}
        document.addEventListener('DOMContentLoaded', function() {
            {% for message in messages %}
                let duration = 5000;
                let type = '{{ message.tags }}';
                let title = 'Notificación';

                if (type.includes('success')) {
                    title = 'Éxito';
                } else if (type.includes('error')) {
                    title = 'Error';
                } else if (type.includes('warning')) {
                    title = 'Advertencia';
                }

                if (type.includes('horario_existe')) {
                    duration = 5000;
                }

                showNotification(type, title, "{{ message }}", duration);
            {% endfor %}
        });
    {% endif %}

    // --- Lógica para las pestañas principales ---
    function setupTabs(prefix) {
        document.querySelectorAll(`.${prefix}-tab`).forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const tabId = button.dataset.tab;
                window.location.hash = tabId;
                switchTab(prefix, tabId);
            });
        });
    }

    function switchTab(prefix, tabId) {
        document.querySelectorAll(`.${prefix}-tab-content`).forEach(content => {
            content.classList.add('hidden');
        });
        document.querySelectorAll(`.${prefix}-tab`).forEach(button => {
            button.classList.remove('tab-active');
            button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-300');
        });

        const tabContent = document.getElementById(`${tabId}-tab`);
        if(tabContent) {
            tabContent.classList.remove('hidden');
        }

        const activeButton = document.querySelector(`.${prefix}-tab[data-tab="${tabId}"]`);
        if(activeButton) {
            activeButton.classList.add('tab-active');
            activeButton.classList.remove('border-transparent', 'text-gray-500');
        }
    }

    // --- Lógica para la pestaña de CREAR HORARIO ---
    function setupCreateScheduleTabs() {
        const presetBtn = document.getElementById('preset-tab-button');
        const customBtn = document.getElementById('custom-tab-button');
        const presetContent = document.getElementById('preset-tab-content');
        const customContent = document.getElementById('custom-tab-content');

        if (!presetBtn) return; // Salir si los elementos no existen

        function switchCreateTab(tab) {
            if (tab === 'preset') {
                presetContent.classList.remove('hidden');
                customContent.classList.add('hidden');
                presetBtn.classList.add('tab-active');
                customBtn.classList.remove('tab-active');
            } else {
                presetContent.classList.add('hidden');
                customContent.classList.remove('hidden');
                presetBtn.classList.remove('tab-active');
                customBtn.classList.add('tab-active');
            }
        }

        presetBtn.addEventListener('click', () => switchCreateTab('preset'));
        customBtn.addEventListener('click', () => switchCreateTab('custom'));
        
        // Estado inicial
        switchCreateTab('preset');
    }

    // --- Lógica para la pestaña de ASIGNAR HORARIOS ---
    function setupAssignmentUI() {
        const scheduleSelect = document.getElementById('schedule-select-for-assignment');
        const assignmentUI = document.getElementById('assignment-ui');
        const availableList = document.getElementById('available-employees');
        const assignedList = document.getElementById('assigned-employees');
        const hiddenInputsContainer = document.getElementById('assigned-employee-inputs');

        if (!scheduleSelect) return; // Salir si los elementos no existen

        scheduleSelect.addEventListener('change', async function() {
            const scheduleId = this.value;
            if (!scheduleId) {
                assignmentUI.classList.add('hidden');
                return;
            }

            const response = await fetch(`/horarios/api/get-empleados/${scheduleId}/`);
            const data = await response.json();

            renderEmployeeLists(data.disponibles, data.asignados);
            assignmentUI.classList.remove('hidden');
        });

        function renderEmployeeLists(available, assigned) {
            availableList.innerHTML = '';
            assignedList.innerHTML = '';
            hiddenInputsContainer.innerHTML = '';

            if (available.length === 0) {
                availableList.innerHTML = `<div class="flex items-center justify-center h-full text-sm text-gray-500 p-4">No hay más empleados disponibles.</div>`;
            } else {
                available.forEach(emp => {
                    const div = createEmployeeElement(emp);
                    div.addEventListener('click', () => moveEmployee(emp, 'assign'));
                    availableList.appendChild(div);
                });
            }

            if (assigned.length === 0) {
                assignedList.innerHTML = `<div class="flex items-center justify-center h-full text-sm text-gray-500 p-4">Aún no hay empleados asignados.</div>`;
            } else {
                assigned.forEach(emp => {
                    const div = createEmployeeElement(emp);
                    div.addEventListener('click', () => moveEmployee(emp, 'unassign'));
                    assignedList.appendChild(div);
                    addHiddenInput(emp.id);
                });
            }
        }

        function createEmployeeElement(employee) {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-3 p-2 rounded-md cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700';
            div.dataset.id = employee.id;
            div.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-gray-400 flex-shrink-0"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span class="text-sm font-medium">${employee.nombre} ${employee.apellido}</span>
            `;
            return div;
        }

        function moveEmployee(employee, action) {
            const element = document.querySelector(`#assign-schedules-tab [data-id='${employee.id}']`);
            if (element) {
                element.remove();
            }

            if (action === 'assign') {
                if (assignedList.querySelector('div.text-gray-500')) {
                    assignedList.innerHTML = '';
                }
                const newElement = createEmployeeElement(employee);
                newElement.addEventListener('click', () => moveEmployee(employee, 'unassign'));
                assignedList.appendChild(newElement);
                addHiddenInput(employee.id);
            } else { // unassign
                if (availableList.querySelector('div.text-gray-500')) {
                    availableList.innerHTML = '';
                }
                const newElement = createEmployeeElement(employee);
                newElement.addEventListener('click', () => moveEmployee(employee, 'assign'));
                availableList.appendChild(newElement);
                removeHiddenInput(employee.id);
            }
            
            if (availableList.children.length === 0) {
                 availableList.innerHTML = `<div class="flex items-center justify-center h-full text-sm text-gray-500 p-4">No hay más empleados disponibles.</div>`;
            }

            if (assignedList.children.length === 0) {
                assignedList.innerHTML = `<div class="flex items-center justify-center h-full text-sm text-gray-500 p-4">Aún no hay empleados asignados.</div>`;
            }

            // Refrescar el historial en tiempo real
            if (window.refreshHistorial) {
                window.refreshHistorial();
            }
        } 

        function addHiddenInput(employeeId) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'empleados';
            input.value = employeeId;
            input.id = `input-emp-${employeeId}`;
            hiddenInputsContainer.appendChild(input);
        }

        function removeHiddenInput(employeeId) {
            const input = document.getElementById(`input-emp-${employeeId}`);
            if (input) {
                input.remove();
            }
        }
    }

    // --- Lógica para la pestaña de HISTORIAL ---
    function setupHistorialTab() {
        const form = document.getElementById('historial-filters-form');
        const tbody = document.getElementById('historial-tbody');

        if (!form || !tbody) return;

        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        const fetchAndRenderHistorial = async () => {
            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                if (value) {
                    params.append(key, value);
                }
            }

            try {
                const response = await fetch(`/horarios/api/historial/?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No se encontraron registros.</td></tr>`;
                    return;
                }

                data.forEach(asignacion => {
                    const row = document.createElement('tr');
                    const estadoBadge = asignacion.estado
                        ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Activo</span>`
                        : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inactivo</span>`;
                    const fecha = new Date(asignacion.fecha_asignacion).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${asignacion.id_empl__nombre} ${asignacion.id_empl__apellido}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${asignacion.id_horario__nombre}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${fecha}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${estadoBadge}</td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error("Error fetching historial:", error);
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-red-500">Error al cargar el historial.</td></tr>`;
            }
        };

        const debouncedFetch = debounce(fetchAndRenderHistorial, 350);

        form.addEventListener('input', debouncedFetch);
        form.addEventListener('change', fetchAndRenderHistorial);

        fetchAndRenderHistorial();

        window.refreshHistorial = fetchAndRenderHistorial;
    }

    // --- Lógica para el modal de eliminación ---
    const deleteModal = document.getElementById('delete-horario-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

    window.openDeleteModal = function(horarioId) {
        const url = `/horarios/eliminar/${horarioId}/`;
        confirmDeleteBtn.href = url;
        deleteModal.classList.remove('hidden');
        deleteModal.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }

    window.closeDeleteModal = function() {
        deleteModal.classList.add('hidden');
        deleteModal.classList.remove('flex');
        document.body.style.overflow = '';
    }

    // --- INICIALIZACIÓN ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded and parsed');
        try {
            setupTabs('schedule');
            console.log('setupTabs OK');
            setupCreateScheduleTabs();
            console.log('setupCreateScheduleTabs OK');
            setupAssignmentUI();
            console.log('setupAssignmentUI OK');
            setupHistorialTab();
            console.log('setupHistorialTab OK');

            document.querySelectorAll('.delete-horario-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const horarioId = this.dataset.horarioId;
                    openDeleteModal(horarioId);
                });
            });
            console.log('Delete buttons OK');
        } catch (error) {
            console.error('Error during initialization:', error);
        }
    });
</script>
{% endblock %}
