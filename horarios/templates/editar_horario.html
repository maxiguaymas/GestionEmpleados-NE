{% extends 'base.html' %}

{% block title %}Editar Horario{% endblock %}

{% block back_button %}
<a href="{% url 'horarios_admin' %}" class="text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-lg transition-colors duration-150">
    <i data-lucide="arrow-left" class="w-5 h-5"></i>
</a>
{% endblock %}

{% block actual_page_title %}Editar Horario{% endblock %}

{% block content %}
<a href="{% url 'horarios_admin' %}" id="volver-btn" class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-500 mb-6">
    <i data-lucide="arrow-left"></i> Volver
</a>
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 max-w-2xl mx-auto">
    <form method="post" id="editar-horario-form" class="space-y-6">
        {% csrf_token %}
        <div>
            <label for="{{ form.nombre.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ form.nombre.label }}</label>
            {{ form.nombre }}
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="{{ form.hora_entrada.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ form.hora_entrada.label }}</label>
                {{ form.hora_entrada }}
            </div>
            <div>
                <label for="{{ form.hora_salida.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ form.hora_salida.label }}</label>
                {{ form.hora_salida }}
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Días de la semana</label>
            <div class="mt-2 flex flex-wrap items-center gap-2">
                {% for field in form %}
                    {% if field.name in "lunes,martes,miercoles,jueves,viernes,sabado,domingo" %}
                    <label for="{{ field.id_for_label }}" class="flex items-center gap-2 p-3 border rounded-lg dark:border-gray-600 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 has-[:checked]:bg-red-50 has-[:checked]:border-red-300 dark:has-[:checked]:bg-red-900/20 dark:has-[:checked]:border-red-700">
                        {{ field }}
                        <span class="font-medium">{{ field.label }}</span>
                    </label>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        <div>
            <label for="{{ form.cantidad_personal_requerida.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ form.cantidad_personal_requerida.label }}</label>
            {{ form.cantidad_personal_requerida }}
        </div>
        <div class="flex justify-end mt-4">
            <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                <i data-lucide="save" class="w-4 h-4"></i>
                <span>Guardar Cambios</span>
            </button>
        </div>
    </form>
</div>

<!-- Modal de Error de Validación -->
<div id="validation-error-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4" onclick="closeValidationErrorModal()">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 m-4 text-center" onclick="event.stopPropagation()">
        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/50">
            <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600 dark:text-red-400"></i>
        </div>
        <h2 class="text-xl font-semibold mt-4">Error de Validación</h2>
        <p id="validation-error-message" class="text-sm text-gray-500 dark:text-gray-400 mt-2"></p>
        <div class="mt-6 flex justify-center gap-3">
            <button type="button" onclick="closeValidationErrorModal()"
                class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 w-full">
                Cerrar
            </button>
        </div>
    </div>
</div>

<!-- Modal de Confirmación para Volver -->
<div id="confirm-back-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 m-4 text-center" onclick="event.stopPropagation()">
        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-yellow-100 dark:bg-yellow-900/50">
            <i data-lucide="alert-circle" class="h-6 w-6 text-yellow-600 dark:text-yellow-400"></i>
        </div>
        <h2 class="text-xl font-semibold mt-4">Cambios sin Guardar</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Hay cambios sin guardar. ¿Estás seguro de que quieres volver?</p>
        <div class="mt-6 flex justify-center gap-3">
            <button type="button" id="cancel-back-btn"
                class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 w-full">
                Cancelar
            </button>
            <button type="button" id="confirm-back-btn"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 w-full">
                Aceptar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editar-horario-form');
    const cantidadInput = document.getElementById('id_cantidad_personal_requerida');
    const personalAsignado = {{ personal_asignado|default:0 }};
    const validationModal = document.getElementById('validation-error-modal');
    const validationModalMessage = document.getElementById('validation-error-message');
    const confirmBackModal = document.getElementById('confirm-back-modal');
    const volverBtn = document.getElementById('volver-btn');
    const confirmBackBtn = document.getElementById('confirm-back-btn');
    const cancelBackBtn = document.getElementById('cancel-back-btn');

    // Store initial form state
    const initialFormData = new FormData(form);
    const initialSerializedData = new URLSearchParams(initialFormData).toString();
    let formChanged = false;

    // Function to check for form changes
    const checkForChanges = () => {
        const currentFormData = new FormData(form);
        const currentSerializedData = new URLSearchParams(currentFormData).toString();
        formChanged = initialSerializedData !== currentSerializedData;
    };

    // Listen for any input changes in the form
    form.addEventListener('input', checkForChanges);
    form.addEventListener('change', checkForChanges); // For checkboxes and selects

    // Handle back button click
    volverBtn.addEventListener('click', function(event) {
        if (formChanged) {
            event.preventDefault();
            confirmBackModal.classList.remove('hidden');
            confirmBackModal.classList.add('flex');
        }
    });

    // Handle confirm back button
    confirmBackBtn.addEventListener('click', function() {
        window.location.href = volverBtn.href;
    });

    // Handle cancel back button
    cancelBackBtn.addEventListener('click', function() {
        confirmBackModal.classList.add('hidden');
        confirmBackModal.classList.remove('flex');
    });

    window.openValidationErrorModal = function(message) {
        validationModalMessage.textContent = message;
        validationModal.classList.remove('hidden');
        validationModal.classList.add('flex');
    }

    window.closeValidationErrorModal = function() {
        validationModal.classList.add('hidden');
        validationModal.classList.remove('flex');
    }

    form.addEventListener('submit', function(event) {
        const cantidadRequerida = parseInt(cantidadInput.value, 10);
        if (isNaN(cantidadRequerida) || cantidadRequerida < personalAsignado) {
            event.preventDefault();
            const message = `La cantidad de personal requerido no puede ser menor que el personal ya asignado (${personalAsignado}).`;
            openValidationErrorModal(message);
        }
    });

    // Cerrar modal haciendo clic fuera o con la tecla Escape
    validationModal.addEventListener('click', function(event) {
        if (event.target === validationModal) {
            closeValidationErrorModal();
        }
    });

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && !validationModal.classList.contains('hidden')) {
            closeValidationErrorModal();
        }
        if (event.key === 'Escape' && !confirmBackModal.classList.contains('hidden')) {
            confirmBackModal.classList.add('hidden');
            confirmBackModal.classList.remove('flex');
        }
    });
});
</script>
{% endblock %}
